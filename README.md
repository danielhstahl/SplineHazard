# SplineHazard

While this is the most recent version of the credit loss model based off time-to-default and splines, it will need a good amount of work to become production ready.  

This model is based off the work in the [FlexSurv](https://cran.r-project.org/web/packages/flexsurv/flexsurv.pdf) R package.  It implements, in C++, the "hazard", "odds", and "normal" models.  This is intended to be a production version using coefficients estimated from the FlexSurv package. 

In tests, the FlexSurv packages does better when only estimating the spline and not the spline AND the coefficients.  It is possible to get around this when using the "odds" model: note that the "odds" model is the same as a logistic model except that there exists an extra "term" (the spline s(x, gamma)) which is time dependent.  This term, in a standard logistic model, is swallowed by the intercept since it is constant given a fixed time horizon.  This allows the model developer to de-mean the explanatory variables and estimate a standard logistic model (given right censored data at some time point t).  Then the developer can estimate the FlexSurv spline without explanatory variables.  The result will be essentially identical to estimating the entire model in FlexSurv since the "average" loan will have all zeros for the affine part of the model.  

To sum up, the process is as follows:

* Obtain loan data
* Pick an arbitrary right censor date (eg 12 months) after origination
* De-mean the explanatory variables
* Estimate a logistic regression (note: a Neural Net with cross-entropy cost function may work as well)
* Separately estimate the FlexSurv spline with no explanatory variables
* Provide the SplineHazard with the coefficients


## Description

This is a C++ engine applying the PD, LGD, and loan contribution models.  It can output CNLs and CULs for any time on books and can predict losses for any calendar month.  Documentation using [doxygen](http://www.stack.nl/~dimitri/doxygen/index.html "doxygen").  


## Install -- Dev

Requires Visual Studio 2015.  By default, uses C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat.  
In the root of the project, run the following commands in order:

`git clone https://github.com/miloyip/rapidjson.git`

`make`  This compiles the program into Main.exe.  If vcvarsall.bat lives in a different directory than C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\, change the make.bat file to point to the directory.

### Documentation generator

`doxygen lossforecasting`  Generates docs into docs/html and docs/latex

## Install -- Prod/Release
TBD!  

### Testing
Must run `test` and then AppTest.exe to ensure that it passes all tests on deploy.

## How to use
The engine communicates over JSON using callbacks.  To send a message to the program, write to the "out" pipe with a string in the following format:

`{"endPointKey":{"id":"yourUniqueId", "data":yourDataObject}}`

Where `endPointKey` is one of `init`, `simulate`, `getParamQueries`, `reset`, `getUnitLoss`,  `getNetForecast`, `getUnitForecast`, `getCUL`, `getCNL`.  These are defined in main.cpp.  `init` must be called first.

`yourUniqueId` is an id which lets a program know which function is being returned.  For example, this is can be generated by a uuid generator.  

The structure of `data` varies depending on the endpoint.  

If there is no error, the engine will return a JSON string in the following format on the "in" pipe:

`{"yourUniqueId": returnedDataObject}`

In the case of an error, the JSON is returned on the "err" pipe and is in the following format:

`{"yourUniqueId": "errDescription"}`

It is recommended that the user create a function in the calling program to automatically filter this data. 




